'use strict';

const Homey = require('homey');
const EventEmitter = require('events');

/**
 * The {@link OAuth2Util} class exposes static methods that are useful for OAuth2 interactions.
 */
class OAuth2Util {

	/**
	 * This method creates a new instance of {@link https://apps.developer.athom.com/CloudOAuth2Callback.html|Homey.CloudOAuth2Callback} based on a provided {@link OAuth2Account}.
	 * It will then handle the OAuth2 exchange to finally retrieve a set of access tokens.
	 * @param {OAuth2Account} oauth2Account - This account is used for the token exchange
	 * @param socket
	 * @returns {EventEmitter}
	 */
	static generateOAuth2Callback(oauth2Account, socket = new EventEmitter()) {
		new Homey.CloudOAuth2Callback(oauth2Account.getOAuth2Url())
			.once('url', url => {
				console.log('_generateOAuth2Callback() -> retrieved authentication url');
				socket.emit('url', url);
			})
			.once('code', code => {
				console.log('_generateOAuth2Callback() -> retrieved authentication code');

				// Fetch access tokens
				oauth2Account.getAccessTokens(code)
					.then(() => {
						console.log('_generateOAuth2Callback() -> successfully retrieved access tokens');
						socket.emit('authorized');
					})
					.catch(err => {
						console.error('_generateOAuth2Callback() error', err.stack);
						socket.emit('error', err);
					});
			})
			.generate();
		return socket;
	}
}

module.exports = OAuth2Util;
